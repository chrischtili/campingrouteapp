<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampingRoute.app - Statistik Dashboard</title>
    <style>
        :root {
            --primary: #4a9b8e;
            --primary-dark: #3a7a6f;
            --secondary: #f8f9fa;
            --text: #333;
            --text-light: #666;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--text);
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary);
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.8rem;
        }

        .header a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .header a:hover {
            color: var(--primary-dark);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-card h3 {
            color: var(--text-light);
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-card .label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .chart-container h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .spinner {
            border: 4px solid rgba(74, 155, 142, 0.2);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: var(--danger);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--danger);
        }

        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
            margin-top: 1rem;
        }

        .refresh-btn:hover {
            background: var(--primary-dark);
        }

        .metadata {
            background: var(--secondary);
            padding: 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 1rem;
        }

        .metadata p {
            margin-bottom: 0.3rem;
        }

        .feedback-list {
            display: grid;
            gap: 1rem;
        }

        .feedback-item {
            border: 1px solid #e4e7eb;
            border-radius: 8px;
            padding: 1rem;
            background: #fafbfc;
        }

        .feedback-item-header {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .feedback-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .feedback-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .feedback-badge.helpful {
            background: rgba(40, 167, 69, 0.12);
            color: var(--success);
        }

        .feedback-badge.not-helpful {
            background: rgba(220, 53, 69, 0.12);
            color: var(--danger);
        }

        .feedback-badge.meta {
            background: rgba(74, 155, 142, 0.12);
            color: var(--primary-dark);
        }

        .feedback-message {
            color: var(--text);
            white-space: pre-wrap;
        }

        .feedback-empty {
            color: var(--text-light);
            font-style: italic;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üìä CampingRoute.app Statistik Dashboard</h1>
            <div>
                <a href="/" style="margin-right: 1rem;">‚Üê Zur√ºck zur Hauptseite</a>
                <button onclick="logout()" style="background: var(--danger); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='var(--danger)'">üîí Logout</button>
            </div>
        </div>

        <div id="login-form">
            <div style="max-width: 400px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); text-align: center;">
                <h2 style="color: var(--primary); margin-bottom: 1.5rem;">üîí Admin Login</h2>
                <input type="text" id="username" placeholder="Benutzername" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                <input type="password" id="password" placeholder="Passwort" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                <button onclick="login()" style="width: 100%; padding: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='var(--primary-dark)'" onmouseout="this.style.background='var(--primary)'">Anmelden</button>
                <p id="login-error" style="color: var(--danger); margin-top: 1rem; min-height: 1rem;"></p>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Lade Statistiken...</p>
        </div>

        <div id="error" class="error" style="display: none;">
            <p><strong>Fehler:</strong> Fehler beim Laden der Statistiken. Bitte versuchen Sie es sp√§ter erneut.</p>
        </div>

        <div id="stats-content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Gesamtbesuche</h3>
                    <div class="value" id="total-visits">-</div>
                    <div class="label">Seit Beginn der Aufzeichnung</div>
                </div>

                <div class="stat-card">
                    <h3>Heutige Besuche</h3>
                    <div class="value" id="today-visits">-</div>
                    <div class="label">Heutiger Tag</div>
                </div>

                <div class="stat-card">
                    <h3>Durchschnitt pro Tag</h3>
                    <div class="value" id="avg-visits">-</div>
                    <div class="label">Letzte 7 Tage</div>
                </div>

                <div class="stat-card">
                    <h3>Feedback gesamt</h3>
                    <div class="value" id="feedback-total">-</div>
                    <div class="label">Abgesendete R√ºckmeldungen</div>
                </div>

                <div class="stat-card">
                    <h3>Hilfreich-Quote</h3>
                    <div class="value" id="feedback-helpful-rate">-</div>
                    <div class="label">Anteil positives Feedback</div>
                </div>

                <div class="stat-card">
                    <h3>Kommentare</h3>
                    <div class="value" id="feedback-comments">-</div>
                    <div class="label">Mit Freitext</div>
                </div>
            </div>

            <div class="chart-container">
                <h2>üìà Besucherverlauf (letzte 7 Tage)</h2>
                <div id="chart" style="height: 300px; background: #f8f9fa; border-radius: 4px; padding: 1rem;">
                    <canvas id="visitsChart" style="width: 100%; height: 100%;"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>üí¨ Letzte Feedbacks</h2>
                <div id="feedback-list" class="feedback-list">
                    <div class="feedback-empty">Noch kein Feedback vorhanden.</div>
                </div>
            </div>

            <div class="metadata">
                <h3>üìä Technische Informationen</h3>
                <p><strong>API-Endpoint:</strong> <code id="api-endpoint">/api/admin/counter</code></p>
                <p><strong>Server:</strong> <span id="server-info">-</span></p>
                <p><strong>Letzte Aktualisierung:</strong> <span id="last-updated">-</span></p>
                <p><strong>API-Version:</strong> <span id="api-version">-</span></p>
            </div>

            <button id="refresh-btn" class="refresh-btn">üîÑ Daten aktualisieren</button>
        </div>
    </div>

    <script>
        // DOM Elemente
        const loginFormEl = document.getElementById('login-form');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const statsContentEl = document.getElementById('stats-content');
        const refreshBtn = document.getElementById('refresh-btn');
        const loginErrorEl = document.getElementById('login-error');
        let latestChartDays = [];
        let resizeTimer = null;

        // Login-Funktion
        let authToken = null;

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Standard-Credentials pr√ºfen
            if (username === 'kopi' && password === 'sugjax-jobnez-8meXdy') {
                // Auth-Token generieren und speichern
                authToken = btoa(username + ':' + password);
                
                loginFormEl.style.display = 'none';
                statsContentEl.style.display = 'block';
                loadStats();
                return;
            }

            // Fehlermeldung anzeigen
            loginErrorEl.textContent = 'Ung√ºltige Anmeldedaten. Bitte versuchen Sie es erneut.';
        }

        // Initial Login-Formular anzeigen
        function init() {
            loginFormEl.style.display = 'block';
            loadingEl.style.display = 'none';
            errorEl.style.display = 'none';
            statsContentEl.style.display = 'none';
            latestChartDays = [];
        }

        // Daten Elemente
        const totalVisitsEl = document.getElementById('total-visits');
        const todayVisitsEl = document.getElementById('today-visits');
        const avgVisitsEl = document.getElementById('avg-visits');
        const feedbackTotalEl = document.getElementById('feedback-total');
        const feedbackHelpfulRateEl = document.getElementById('feedback-helpful-rate');
        const feedbackCommentsEl = document.getElementById('feedback-comments');
        const feedbackListEl = document.getElementById('feedback-list');
        const apiEndpointEl = document.getElementById('api-endpoint');
        const serverInfoEl = document.getElementById('server-info');
        const lastUpdatedEl = document.getElementById('last-updated');
        const apiVersionEl = document.getElementById('api-version');

        function updateFeedbackStats(data) {
            const total = typeof data?.total === 'number' ? data.total : 0;
            const helpful = typeof data?.helpful === 'number' ? data.helpful : 0;
            const comments = typeof data?.comments === 'number' ? data.comments : 0;
            const helpfulRate = total > 0 ? Math.round((helpful / total) * 100) : 0;

            feedbackTotalEl.textContent = total.toLocaleString('de-DE');
            feedbackHelpfulRateEl.textContent = `${helpfulRate} %`;
            feedbackCommentsEl.textContent = comments.toLocaleString('de-DE');
        }

        function renderFeedbackList(items = []) {
            if (!Array.isArray(items) || items.length === 0) {
                feedbackListEl.innerHTML = '<div class="feedback-empty">Noch kein Feedback vorhanden.</div>';
                return;
            }

            feedbackListEl.innerHTML = items.map((item) => {
                const ratingLabel = item.rating === 'helpful' ? 'Hilfreich' : 'Nicht hilfreich';
                const ratingClass = item.rating === 'helpful' ? 'helpful' : 'not-helpful';
                const modeLabel = item.mode === 'route' ? 'Route' : 'Prompt';
                const createdAt = item.createdAt
                    ? new Date(item.createdAt).toLocaleString('de-DE')
                    : '-';
                const provider = item.provider || 'unbekannt';
                const message = item.message && item.message.trim()
                    ? item.message
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                    : '<span class="feedback-empty">Kein Freitext hinterlegt.</span>';

                return `
                    <div class="feedback-item">
                        <div class="feedback-item-header">
                            <div class="feedback-badges">
                                <span class="feedback-badge ${ratingClass}">${ratingLabel}</span>
                                <span class="feedback-badge meta">${modeLabel}</span>
                                <span class="feedback-badge meta">${provider}</span>
                            </div>
                            <div style="color: var(--text-light); font-size: 0.85rem;">${createdAt}</div>
                        </div>
                        <div class="feedback-message">${message}</div>
                    </div>
                `;
            }).join('');
        }

        function toLocalDateKey(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getLastSevenDays(history = {}) {
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setHours(0, 0, 0, 0);
                date.setDate(date.getDate() - i);
                const key = toLocalDateKey(date);
                days.push({
                    key,
                    label: `${date.getDate()}.${date.getMonth() + 1}`,
                    value: Number(history[key] || 0)
                });
            }
            return days;
        }

        // Daten laden
        async function loadStats(options = {}) {
            const { silent = false } = options;
            try {
                const hasVisibleContent = statsContentEl.style.display !== 'none';
                loadingEl.style.display = silent || hasVisibleContent ? 'none' : 'block';
                errorEl.style.display = 'none';
                if (!silent && !hasVisibleContent) {
                    statsContentEl.style.display = 'none';
                }

                console.log('Lade Statistiken...');

                const response = await fetch('/api/admin/counter?' + Date.now(), {
                    headers: {
                        'Authorization': 'Basic ' + authToken
                    },
                    credentials: 'include'
                });

                console.log('Response Status:', response.status);
                console.log('Response Headers:', [...response.headers.entries()]);

                let data = null;
                try {
                    data = await response.json();
                } catch {
                    throw new Error('API liefert kein g√ºltiges JSON');
                }

                console.log('Response Data:', data);

                let feedbackSummary = { total: 0, helpful: 0, comments: 0 };
                let feedbackItems = [];
                try {
                    const feedbackResponse = await fetch('/api/admin/feedback?' + Date.now(), {
                        headers: {
                            'Authorization': 'Basic ' + authToken
                        },
                        credentials: 'include'
                    });
                    if (feedbackResponse.ok) {
                        const feedbackData = await feedbackResponse.json();
                        feedbackSummary = feedbackData?.summary || feedbackData || feedbackSummary;
                        feedbackItems = feedbackData?.latest || [];
                    }
                } catch (feedbackError) {
                    console.warn('Feedback konnte nicht geladen werden:', feedbackError);
                }

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Zugang verweigert - Ung√ºltige Anmeldedaten');
                    }
                    throw new Error(data?.error || `HTTP ${response.status}`);
                }

                const visits =
                    typeof data?.data?.visits === 'number' ? data.data.visits :
                    typeof data?.visits === 'number' ? data.visits :
                    null;

                if (visits === null) {
                    throw new Error('Antwort enth√§lt kein Feld "visits"');
                }

                const history = data?.data?.history || data?.history || {};
                const meta = data?.meta || {};
                const lastSevenDays = getLastSevenDays(history);
                const todayKey = toLocalDateKey();
                const todayVisits = Number(history[todayKey] || 0);
                const sevenDayTotal = lastSevenDays.reduce((sum, day) => sum + day.value, 0);
                const averageVisits = lastSevenDays.length ? sevenDayTotal / lastSevenDays.length : 0;
                latestChartDays = lastSevenDays;

                totalVisitsEl.textContent = visits.toLocaleString('de-DE');
                todayVisitsEl.textContent = todayVisits.toLocaleString('de-DE');
                avgVisitsEl.textContent = averageVisits.toFixed(1).replace('.', ',');
                updateFeedbackStats(feedbackSummary);
                renderFeedbackList(feedbackItems);

                setTimeout(() => drawChart(latestChartDays), 100);

                apiEndpointEl.textContent = '/api/admin/counter';
                serverInfoEl.textContent = meta.server || 'Counter API';
                lastUpdatedEl.textContent = meta.timestamp
                    ? new Date(meta.timestamp).toLocaleString('de-DE')
                    : new Date().toLocaleString('de-DE');
                apiVersionEl.textContent = meta.version || 'n/a';

                loadingEl.style.display = 'none';
                statsContentEl.style.display = 'block';

            } catch (error) {
                console.error('Fehler beim Laden der Statistiken:', error);
                errorEl.innerHTML = `<p><strong>Fehler:</strong> ${error.message}</p>`;
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                statsContentEl.style.display = 'none';
            }
        }

        // Event Listener
        refreshBtn.addEventListener('click', () => loadStats({ silent: true }));

        // Chart zeichnen
        function drawChart(days = []) {
            const canvas = document.getElementById('visitsChart');
            if (!canvas) {
                console.error('Canvas nicht gefunden');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Kontext nicht verf√ºgbar');
                return;
            }
            
            // Canvas Gr√∂√üe anpassen
            const parent = canvas.parentElement;
            canvas.width = parent ? parent.clientWidth : 600;
            canvas.height = 300;
            
            // Hintergrund l√∂schen
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Daten vorbereiten
            const preparedDays = Array.isArray(days) && days.length
                ? days
                : getLastSevenDays({});
            const values = preparedDays.map((day) => day.value);
            const labels = preparedDays.map((day) => day.label);

            // Hintergrund
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Titel
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Besucherverlauf (letzte 7 Tage)', canvas.width / 2, 25);
            
            // Balken zeichnen
            const barWidth = canvas.width / values.length - 20;
            const maxValue = Math.max(...values, 10);
            const scale = canvas.height / maxValue * 0.8;
            
            values.forEach((value, i) => {
                const x = i * (barWidth + 20) + 30;
                const barHeight = value * scale;
                const y = canvas.height - barHeight - 30;
                
                // Balken
                ctx.fillStyle = 'rgba(74, 155, 142, 0.7)';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Wert
                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(value, x + barWidth / 2, y - 5);
                
                // Tag
                ctx.fillText(labels[i], x + barWidth / 2, canvas.height - 10);
            });
            
            // Achsen
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(30, canvas.height - 30);
            ctx.lineTo(canvas.width - 10, canvas.height - 30);
            ctx.stroke();
        }

        // Logout-Funktion
        function logout() {
            loginFormEl.style.display = 'block';
            statsContentEl.style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            loginErrorEl.textContent = '';
        }

        // Initialisierung
        init();

        // Chart bei Fenstergr√∂√üen√§nderung neu zeichnen
        window.addEventListener('resize', () => {
            if (statsContentEl.style.display !== 'none') {
                window.clearTimeout(resizeTimer);
                resizeTimer = window.setTimeout(() => {
                    drawChart(latestChartDays);
                }, 150);
            }
        });

        // Alle 5 Minuten automatisch aktualisieren (nur wenn eingeloggt)
        const interval = setInterval(() => {
            if (statsContentEl.style.display !== 'none') {
                loadStats({ silent: true });
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
